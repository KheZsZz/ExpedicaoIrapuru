import pandas as pd
import streamlit as st
from io import StringIO

# ==============================
# ğŸ§© CONFIGURAÃ‡ÃƒO INICIAL
# ==============================
st.set_page_config(page_title="Painel Operacional", page_icon="ğŸš›", layout="wide")

st.title("ğŸš› Painel Operacional - AnÃ¡lises de Viagens")
st.markdown("Dashboard interativo com base no histÃ³rico de lanÃ§amentos, baixas e emissÃµes de CT-e/NF-e.")

# ==============================
# ğŸ“‚ UPLOAD OU FONTE DE DADOS
# ==============================
st.sidebar.header("ğŸ“¤ Fonte de Dados")
uploaded_file = st.sidebar.file_uploader("Envie o arquivo CSV (ou TXT)", type=["csv", "txt"])

if uploaded_file is not None:
    content = uploaded_file.read().decode("utf-8")
    df = pd.read_csv(StringIO(content), sep="\t|,", engine="python")
else:
    st.warning("Envie o arquivo CSV com as colunas: Data, Placa, InÃ­cio, FinalizaÃ§Ã£o, Total (min), Destino, Tipo, CT-e emitido, RecepÃ§Ã£o de NFs, PedÃ¡gio, UsuÃ¡rio, OBS.")
    st.stop()

# ==============================
# ğŸ”§ LIMPEZA E AJUSTES
# ==============================
df.columns = df.columns.str.strip()
df['Data'] = pd.to_datetime(df['Data'], errors='coerce', dayfirst=True)
df['Total (min)'] = pd.to_timedelta(df['Total (min)'], errors='coerce').dt.total_seconds() / 60
df['CT-e emitido'] = df['CT-e emitido'].astype(str).str.upper().isin(['TRUE', 'VERDADEIRO', '1'])
df['RecepÃ§Ã£o de NFs'] = df['RecepÃ§Ã£o de NFs'].astype(str).str.upper().isin(['TRUE', 'VERDADEIRO', '1'])
df['PedÃ¡gio'] = df['PedÃ¡gio'].astype(str).str.upper().isin(['TRUE', 'VERDADEIRO', '1'])

# ==============================
# ğŸ§® FILTROS
# ==============================
st.sidebar.header("ğŸ” Filtros")

datas = st.sidebar.multiselect("Filtrar por Data:", sorted(df['Data'].dropna().unique()))
if datas:
    df = df[df['Data'].isin(datas)]

placas = st.sidebar.multiselect("Filtrar por Placa:", sorted(df['Placa'].dropna().unique()))
if placas:
    df = df[df['Placa'].isin(placas)]

tipos = st.sidebar.multiselect("Filtrar por Tipo:", sorted(df['Tipo'].dropna().unique()))
if tipos:
    df = df[df['Tipo'].isin(tipos)]

destinos = st.sidebar.multiselect("Filtrar por Destino:", sorted(df['Destino'].dropna().unique()))
if destinos:
    df = df[df['Destino'].isin(destinos)]

st.sidebar.markdown("---")
st.sidebar.info(f"Total de registros filtrados: {len(df)}")

# ==============================
# ğŸ“Š MÃ‰TRICAS RESUMO
# ==============================
col1, col2, col3, col4 = st.columns(4)

col1.metric("â± Tempo Total (min)", f"{df['Total (min)'].sum():,.0f}")
col2.metric("ğŸ“¦ Total de OperaÃ§Ãµes", f"{len(df):,}")
col3.metric("ğŸ§¾ % CT-e Emitido", f"{(df['CT-e emitido'].mean()*100):.1f}%")
col4.metric("ğŸ’° % com PedÃ¡gio", f"{(df['PedÃ¡gio'].mean()*100):.1f}%")

# ==============================
# ğŸ“ˆ GRÃFICOS PRINCIPAIS
# ==============================
st.subheader("ğŸ“Š VisÃ£o Geral das OperaÃ§Ãµes")

aba1, aba2, aba3 = st.tabs(["Por Tipo", "Por Destino", "Por Data"])

with aba1:
    tipo_sum = df.groupby("Tipo")["Total (min)"].sum().sort_values(ascending=False)
    st.bar_chart(tipo_sum, use_container_width=True)

with aba2:
    dest_sum = df.groupby("Destino")["Total (min)"].sum().sort_values(ascending=False).head(10)
    st.bar_chart(dest_sum, use_container_width=True)

with aba3:
    data_sum = df.groupby("Data")["Total (min)"].sum().sort_index()
    st.line_chart(data_sum, use_container_width=True)

# ==============================
# ğŸšš DETALHAMENTO
# ==============================
st.subheader("ğŸ“‹ Detalhamento das OperaÃ§Ãµes")

st.dataframe(
    df[[
        "Data", "Placa", "Tipo", "Destino", "Total (min)",
        "CT-e emitido", "RecepÃ§Ã£o de NFs", "PedÃ¡gio", "OBS"
    ]],
    use_container_width=True,
    hide_index=True
)

# ==============================
# ğŸ“¤ EXPORTAÃ‡ÃƒO
# ==============================
st.download_button(
    "â¬‡ï¸ Baixar CSV Filtrado",
    df.to_csv(index=False).encode("utf-8"),
    "relatorio_filtrado.csv",
    "text/csv"
)

# ==============================
# ğŸ§  INSIGHTS AUTOMÃTICOS
# ==============================
st.subheader("ğŸ’¡ Insights AutomÃ¡ticos")

mais_lento = df.loc[df['Total (min)'].idxmax()] if len(df) > 0 else None
if mais_lento is not None:
    st.markdown(f"""
    - ğŸš› **Placa com maior operaÃ§Ã£o:** `{mais_lento['Placa']}` com **{mais_lento['Total (min)']:.0f} min**
    - ğŸ™ï¸ **Destino:** {mais_lento['Destino']}
    - ğŸ“… **Data:** {mais_lento['Data'].strftime('%d/%m/%Y')}
    """)

if df['CT-e emitido'].mean() < 0.7:
    st.warning("âš ï¸ Menos de 70% das operaÃ§Ãµes tiveram CT-e emitido.")
else:
    st.success("âœ… Alta conformidade de emissÃ£o de CT-e.")

if df['PedÃ¡gio'].mean() > 0.5:
    st.info("ğŸ’° Mais da metade das viagens teve pedÃ¡gio registrado.")

st.markdown("---")
st.caption("Desenvolvido por Kevin Oliveira - AnÃ¡lise Operacional AutomÃ¡tica Â© 2025")
